<!DOCTYPE html>
<html>
  <head>
    <title>Distances</title>
    <script src='https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true'></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  </head>

  <body>
    <div id="inputs">
      <form>
        <input id="destination" type="text" placeholder="Add City"></input>
        <input id="submitButton" type="submit"></input>
      </form>
    </div>
    <div id="outputs">
      <h1 id="distanceh1"></h1>
      <ol id="outputDiv"></ol>
    </div>
    <button type="button" id="clearButton">Delete All</button>
    <button type="button" id="downloadButton">Download</button>

    <script>
      var origin = 'Thessaloniki';
      //matrix containing history of cities
      var destination = [];
      var totalKM = 0;

      function calculateDistances(city) {
        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
          {
          origins: [origin],
          destinations: [city],
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC,
          avoidHighways: false,
          avoidTolls: false
        }, function (response, status) {callback(response, status, city)}
        );
      }

      function callback(response, status, city) {
        console.log(response);
        removeWaiting(city);
        if(response.rows[0].elements[0].status == "NOT_FOUND") {
          addOutput(city + " no such city", "NOT_FOUND");
          return;
        }
        if(response.rows[0].elements[0].status == "ZERO_RESULTS") {
          addOutput(city + " is way too far", "ZERO_RESULTS");
          return;
        }

        if (status != google.maps.DistanceMatrixStatus.OK) {
          alert('Error was: ' + status);
          addOutput('From ' + city + ': no response', "OK");
        } else {
          var results = response.rows[0].elements;
          totalKM += parseInt(results[0].distance.value / 1000);
          text = 'From ' + response.destinationAddresses + ': ' + results[0].distance.text + ' in ' + results[0].duration.text;
          addOutput(text, "OK");
        }
      }

      function addOutput(text, id) {
        var list = document.getElementById('outputDiv');
        var node = document.createElement("LI");
        node.id = id;
        var textnode = document.createTextNode(text);
        node.appendChild(textnode);
        var removeButton = document.createElement("button");
        removeButton.innerHTML = "remove";
        removeButton.onclick = function () {
          list.removeChild(node);
        };
        node.appendChild(removeButton);
        list.insertBefore(node, list.childNodes[0]);
        document.getElementById('distanceh1').innerHTML = 'Total ' + totalKM + ' km';
      }

      function removeWaiting(city) {
        var elem = document.getElementById(city);
        elem.parentNode.removeChild(elem);
      }

      document.getElementById("submitButton").addEventListener("click", function(event){
        event.preventDefault();
        var newCity = document.getElementById("destination").value;
        destination.push(newCity);
        addOutput("Waiting response from " + newCity, newCity);
        var log = destination.toString();
        localStorage.setItem('cities', log);
        localStorage.setItem('total', totalKM);
        if (!navigator.onLine) {
          addOutput('From ' + newCity + ': lost connection');
        } else {
          calculateDistances(newCity);
        }
        document.getElementById("destination").value = '';
      });

      document.getElementById("clearButton").addEventListener("click", function(event){
        var confirmDelete = confirm("Are you sure you want to delete all records?");
        if (confirmDelete) {
          localStorage.removeItem('cities');
          localStorage.removeItem('total');
          location.reload();
        }
      });

      document.getElementById("downloadButton").addEventListener("click", function(event){
        var element = document.createElement('a');
        var textContents = destination.toString() + '\n' + document.getElementById('distanceh1').innerHTML;
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(textContents));
        element.setAttribute('download', 'cities.txt');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      });

      //restore state
      var cities = localStorage.getItem('cities');
      if (cities !== null) {
        for (c of cities.split(",")) {
          destination.push(c);
          addOutput("Waiting response from " + c, c);
          calculateDistances(c);
        }
      }

    </script>

  </body>
</html>

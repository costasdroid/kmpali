<!DOCTYPE html>
<html lang="el">
  <head>
    <meta charset="UTF-8">
    <title>Distances</title>
    <script src='https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true'></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  </head>

  <body>
    <div id="inputs">
      <form>
        <input id="destination" type="text" placeholder="Add City"></input>
        <input id="submitButton" type="submit"></input>
      </form>
    </div>
    <div id="outputs">
      <h1 id="distanceh1"></h1>
      <ol id="outputDiv"></ol>
    </div>
    <button type="button" id="clearButton">Delete All</button>
    <button type="button" id="downloadButton">Download</button>

    <script>
      var origin = 'Thessaloniki';
      //matrix containing all cities
      var destination = [];
      var totalKM = 0;

      //call to google maps api
      function calculateDistances(city) {
        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
          {
          origins: [origin],
          destinations: [city],
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC,
          avoidHighways: false,
          avoidTolls: false
        }, function (response, status) {callback(response, status, city)}
        );
      }

      function callback(response, status, city) {
        removeWaiting(city);
        if(response.rows[0].elements[0].status == "NOT_FOUND") {
          addOutput("Δεν βρέθηκε η πόλη " + city, "NOT_FOUND", city, 0);
          return;
        }
        if(response.rows[0].elements[0].status == "ZERO_RESULTS") {
          addOutput(city + " είναι πολύ μακρυά", "ZERO_RESULTS", city, 0);
          return;
        }

        if (status != google.maps.DistanceMatrixStatus.OK) {
          alert('Error was: ' + status);
          addOutput('Από ' + city + ': δεν βρέθηκε απάντηση', "OK", city);
        } else {
          var results = response.rows[0].elements;
          totalKM += parseInt(results[0].distance.value / 1000);
          text = 'Aπό ' + response.destinationAddresses + ': ' + results[0].distance.text + ' σε ' + results[0].duration.text;
          addOutput(text, "OK", city, parseInt(results[0].distance.value / 1000));
        }
      }

      function addOutput(text, id, city, km) {
        var list = document.getElementById('outputDiv');
        var node = document.createElement("LI");
        node.id = id;
        var textnode = document.createTextNode(text);
        node.appendChild(textnode);
        var removeButton = document.createElement("button");
        removeButton.innerHTML = "remove";
        removeButton.onclick = function () {
          var confirmDelete = confirm('Σίγουρα θέλεις να διαγράψεις τη/το ' + city + '?');
          if (confirmDelete) {
            list.removeChild(node);
            destination.splice(destination.indexOf(city), 1);
            totalKM -= km;
            updateDistance();
            storeValues();
          }
        };
        node.appendChild(removeButton);
        list.insertBefore(node, list.childNodes[0]);
        updateDistance();
      }

      function removeWaiting(city) {
        var elem = document.getElementById(city);
        elem.parentNode.removeChild(elem);
      }

      function updateDistance() {
        document.getElementById('distanceh1').innerHTML = 'Σύνολο ' + totalKM + ' χμ';
      }

      function storeValues() {
        if (destination.length != 0) {
          localStorage.setItem('cities', destination.toString());
          localStorage.setItem('total', totalKM);
        } else {
          localStorage.removeItem('cities');
        }
      }

      document.getElementById("submitButton").addEventListener("click", function(event){
        event.preventDefault();
        var newCity = document.getElementById("destination").value;
        destination.push(newCity);
        addOutput("Αναμένεται απάντηση από " + newCity, newCity);
        storeValues();
        if (!navigator.onLine) {
          removeWaiting(newCity);
          addOutput('From ' + newCity + ': δεν υπάρχει σύνδεση');
        } else {
          calculateDistances(newCity);
        }
        document.getElementById("destination").value = '';
      });

      document.getElementById("clearButton").addEventListener("click", function(event){
        var confirmDelete = confirm("Σίγουρα θέλεις να διαγράψεις όλα τα δεδομένα?");
        if (confirmDelete) {
          localStorage.removeItem('cities');
          localStorage.removeItem('total');
          location.reload();
        }
      });

      document.getElementById("downloadButton").addEventListener("click", function(event){
        var element = document.createElement('a');
        var textContents = destination.toString() + '\n' + document.getElementById('distanceh1').innerHTML;
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(textContents));
        element.setAttribute('download', 'cities.txt');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      });

      //restore state
      var cities = localStorage.getItem('cities');
      if (cities !== null) {
        for (c of cities.split(",")) {
          destination.push(c);
          addOutput("Waiting response from " + c, c);
          calculateDistances(c);
        }
      }

    </script>

  </body>
</html>

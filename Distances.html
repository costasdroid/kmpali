<!DOCTYPE html>
<html lang="el">
  <head>
    <meta charset="UTF-8">
    <title>Distances</title>
    <script src='https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true'></script>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="jquery/jquery-2.1.4.min.js"></script>
  </head>

  <body style="background-image:url(paok.jpg); background-repeat: no-repeat; background-position: 50% 70%; background-attachment: fixed">
    <div class="container">
      <form class="form-inline" role="form">
        <div class="input-group">
          <input id="destination" type="text" placeholder="Πρόσθεσε πόλη" class="form-control"></input>
          <span class="input-group-btn">
            <input id="submitButton" type="submit" class="btn btn-default"></input>
          </span>
        </div>
      </form>
    </div>
    <div class="container">
      <div id="outputs">
        <h1 id="distanceh1"></h1>
        <ol id="outputDiv" class="list-group" style="opacity: 0.8"></ol>
      </div>
      <button type="button" id="clearButton" class="btn btn-warning">Delete All</button>
      <button type="button" id="downloadButton" class="btn btn-default">Download</button>
    </div>

    <script>
      function Destination(name, distance) {
        this.name = name;
        this.distance = distance;
      }

      //matrix containing all cities
      var destinations = [];

      var origin = 'Thessaloniki';
      var totalKM = 0;

      //call to google maps api
      function calculateDistance(city) {
        addOutput(city);
        destinations.push(new Destination(city));
        if (navigator.onLine) {
          callAPI(city);
        } else {
          updateWaiting(city, 'Για ' + city + ': ανανέωσε όταν υπάρχει internet');
        }
      }

      function addOutput(city) {
        var newItem = $("<li></li>");
        newItem
          .text("Αναμένεται απάντηση από " + city)
          .attr("id", "list" + city)
          .data("city", city)
          .addClass("list-group-item")
          .addClass("waiting")
          .append($("<span class='glyphicon glyphicon-remove pull-right'></span>")
            .click(function () {
              var confirmDelete = confirm('Σίγουρα θέλεις να διαγράψεις τη/το ' + city + '?');
              if (confirmDelete) {
                var parent = $(this).parent();
                removeDestination(parent.data("city"), parent.data("km"));
                parent.remove();
              }
            }))
          .prependTo("#outputDiv");
      }

      function callAPI(city) {
        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
          {
          origins: [origin],
          destinations: [city],
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC,
          avoidHighways: false,
          avoidTolls: false
          }, function (response, status) {callback(response, status, city)}
        );
      }

      function callback(response, status, city) {
        if(response.rows[0].elements[0].status == "NOT_FOUND") {
          updateWaiting(city, "Δεν βρέθηκε η πόλη " + city);
          updateDestination(city);
          return;
        }
        if(response.rows[0].elements[0].status == "ZERO_RESULTS") {
          updateWaiting(city, city + " είναι πολύ μακρυά");
          updateDestination(city);
          return;
        }

        if (status != google.maps.DistanceMatrixStatus.OK) {
          alert('Error was: ' + status);
          updateWaiting(city, 'Από ' + city + ': δεν βρέθηκε απάντηση');
          updateDestination(city);
        } else {
          var results = response.rows[0].elements;
          var km = parseInt(results[0].distance.value / 1000);
          text = 'Aπό ' + response.destinationAddresses + ': ' + km + ' χλμ';
          updateWaiting(city, text, km);
          updateDestination(city, km);
        }
      }

      function updateWaiting(city, text, km) {
        var elem = $('li[id="list' + city + '"]');
        elem
          .contents()
          .filter(function() {
            return this.nodeType === 3;
          })
          .replaceWith(text);
        elem
          .data("km", km)
          .removeClass("waiting")
          .attr("id", city);
        if(km == undefined)
          elem.addClass("list-group-item-danger");
        else
          elem.addClass("list-group-item-success");
      }

      function updateDestination(city, km, geo) {
        for (dest of destinations) {
          if (dest.name == city && dest.distance == undefined) {
            dest.distance = km;
            totalKM += km || 0;
            updateDistance();
            storeValues();
            break;
          }
        }
      }

      function removeDestination(city, km) {
        for (var index = 0; index < destinations.length; index++) {
          if (destinations[index].name == city && destinations[index].distance == km) {
            break;
          }
        }
        destinations.splice(index, 1);
        totalKM -= km || 0;
        updateDistance();
        storeValues();
      }

      function updateDistance() {
        $("#distanceh1").html('Σύνολο ' + totalKM + ' χμ');
      }

      function storeValues() {
        if (destinations.length != 0) {
          localStorage.setItem('destinations', JSON.stringify(destinations));
          localStorage.setItem('total', totalKM);
        } else {
          localStorage.removeItem('destinations');
        }
      }

      $("#submitButton").click(function(event){
        event.preventDefault();
        calculateDistance($("#destination").val());
        $("#destination").val('');
      });

      $("#clearButton").click(function(event){
        var confirmDelete = confirm("Σίγουρα θέλεις να διαγράψεις όλα τα δεδομένα?");
        if (confirmDelete) {
          localStorage.removeItem('destinations');
          localStorage.removeItem('total');
          location.reload();
        }
      });

      $("#downloadButton").click(function(event){
        var element = document.createElement('a');
        var textContents = localStorage.getItem('destinations') + '\n' + document.getElementById('distanceh1').innerHTML;
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(textContents));
        element.setAttribute('download', 'cities.txt');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      });

      //restore state
      var storedDestinations = JSON.parse(localStorage.getItem('destinations'));
      if (storedDestinations !== null) {
        for (d of storedDestinations) {
          calculateDistance(d.name);
        }
      }

    </script>
  </body>
</html>

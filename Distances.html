<!DOCTYPE html>
<html>
  <head>
    <title>Distances</title>
    <script src='https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true'></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  </head>

  <body>
    <div id="inputs">
      <form>
        <input id="destination" type="text" placeholder="Add City"></input>
        <input id="submitButton" type="submit"></input>
      </form>
    </div>
    <div id="outputs">
      <h1 id="distanceh1"></h1>
      <ol id="outputDiv"></ol>
    </div>
    <button type="button" id="clearButton">Delete All</button>
    <button type="button" id="downloadButton">Download</button>

    <script>
      var origin = 'Thessaloniki';
      var destination = [];
      var totalKM = 0;
      var totalCities = 0;

      function calculateDistances() {
        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
          {
          origins: [origin],
          destinations: [destination[totalCities - 1]],
          travelMode: google.maps.TravelMode.DRIVING,
          unitSystem: google.maps.UnitSystem.METRIC,
          avoidHighways: false,
          avoidTolls: false
          }, callback
        );
      }

      function callback(response, status) {
        if (status != google.maps.DistanceMatrixStatus.OK) {
          alert('Error was: ' + status);
          addOutput('From ' + destination[totalCities - 1] + ': no response');
        } else {
          var results = response.rows[0].elements;
          totalKM += parseInt(results[0].distance.value / 1000);
          text = 'From ' + response.destinationAddresses + ': ' + results[0].distance.text + ' in ' + results[0].duration.text;
          addOutput(text);
        }
      }

      function addOutput(text) {
          var node = document.createElement("LI");
          var textnode = document.createTextNode(text);
          node.appendChild(textnode);
          document.getElementById('outputDiv').appendChild(node);
          document.getElementById('distanceh1').innerHTML = 'Total ' + totalKM + ' km';
          document.getElementById("destination").value = '';
      }

      document.getElementById("submitButton").addEventListener("click", function(event){
        event.preventDefault();
        destination.push(document.getElementById("destination").value);
        totalCities++;
        if (!navigator.onLine) {
          addOutput('From ' + destination[totalCities - 1] + ': lost connection');
        } else {
          calculateDistances();
          var log = destination.toString();
          localStorage.setItem('cities', log);
          localStorage.setItem('total', totalKM);
        }
      });

      document.getElementById("clearButton").addEventListener("click", function(event){
        var confirmDelete = confirm("Are you sure you want to delete all records?");
        if (confirmDelete) {
          localStorage.removeItem('cities');
          localStorage.removeItem('total');
          location.reload();
        }
      });

      document.getElementById("downloadButton").addEventListener("click", function(event){
        var element = document.createElement('a');
        var textContents = destination.toString() + '\n' + document.getElementById('distanceh1').innerHTML;
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(textContents));
        element.setAttribute('download', 'cities.txt');
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      });

      //restore state
      var cities = localStorage.getItem('cities');
      if (cities !== null) {
        for (c of cities.split(",")) {
          destination.push(c);
          totalCities++;
          calculateDistances();
        }
      }

    </script>

  </body>
</html>
